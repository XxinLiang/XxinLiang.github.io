---
layout: post

title: 百度IFE2016编码挑战总结-02

date: 2016-03-26

categories: blog

tags: [总结,IFE,HTML,JS]

description: 百度前端技术学院学习笔记
---

### task002

3月21日IFE更新了第二阶段的任务，密密麻麻的二十多个，看的我都懵逼了，不过好在都比较有意思，其中行星与飞船系列任务对与我这种科幻迷来说最有趣，因此也是先做的这一系列任务，在这里与大家分享下过程中的收获。

#### task002_26 行星与飞船（一）

任务描述

[如图（打开查看）](http://7xrp04.com1.z0.glb.clouddn.com/task_2_26_1.jpg)，创建一个虚拟宇宙，包括一个行星和飞船

每个飞船由以下部分组成

动力系统，可以完成飞行和停止飞行两个行为，暂定所有飞船的动力系统飞行速度是一致的，比如每秒20px，飞行过程中会按照一定速率消耗能源（比如每秒减5%）

能源系统，提供能源，并且在宇宙中通过太阳能充电（比如每秒增加2%，具体速率自定）

信号接收处理系统，用于接收行星上的信号

自爆系统，用于自我销毁

每个飞船的能源是有限的，用一个属性来表示能源剩余量，这是一个百分比，表示还剩余多少能源。

能源耗尽时，飞船会自动停止飞行

飞船有两个状态：飞行中和停止，飞船的行为会改变这个属性状态

飞船的自我销毁方法会立即销毁飞船自身

行星上有一个指挥官（不需要在页面上表现出其形象），指挥官可以通过行星上的信号发射器发布如下命令

创建一个新的飞船进入轨道，最多可以创建4个飞船，刚被创建的飞船会停留在某一个轨道上静止不动

命令某个飞船开始飞行，飞行后飞船会围绕行星做环绕运动，需要模拟出这个动画效果

命令某个飞船停止飞行

命令某个飞船销毁，销毁后飞船消失、飞船标示可以用于下次新创建的飞船

你需要设计类似如下指令格式的数据格式

```
{
    id: 1,
    commond: 'stop'
}
```

指挥官通过信号发射器发出的命令是通过一种叫做Mediator的介质进行广播

Mediator是单向传播的，只能从行星发射到宇宙中，在发射过程中，有30%的信息传送失败（丢包）概率，你需要模拟这个丢包率，另外每次信息正常传送的时间需要1秒

指挥官并不知道自己的指令是不是真的传给了飞船，飞船的状态他是不知道的，他只能通过自己之前的操作来假设飞船当前的状态

每个飞船通过信号接收器，接受到通过Mediator传达过来的指挥官的广播信号，但因为是广播信号，所以每个飞船能接受到指挥官发出给所有飞船的所有指令，因此需要通过读取信息判断这个指令是不是发给自己的

我的代码实现

二话不说，先看看[我的宇宙](http://xxthink.com/baidu-ife/task/task002/task002_26/index.html)

因为看到任务那两天刚好在学canvas，因此没怎么纠结我就选择了canvas。刚开始写JS的时候由于没有将逻辑理清楚，
将创建飞船、操作飞船都写成了指挥官的方法，写到后面发现还有个Mediator！那这个丢包率就只能写在指挥官的方法里了，于是我一怒之下全部推倒重新写，这次理清楚了逻辑，指挥官只负责发送指令，Mediator介质传播指令，而飞船接受指令，码代码速度快了不少，所以写代码前还是要冷静啊少年。

在这个任务中踩到了一个坑，如果对同一元素进行重复绑定，会出现处罚几次就执行几次的情况，这是由于jQuery的事件绑定机制里用数组来保存事件，如果对同一元素进行重复绑定，不会覆盖之前已经绑定的事件，只是把新的绑定事件再push到保存事件的数组中，当事件触发时就会循环执行数组中的事件。

解决这个问题的方法有两种

+ 绑定前使用off()方法一次性解除所有的绑定

+ 使用one()绑定

想看具体代码的同学可以[点击这里](https://github.com/XxinLiang/baidu-ife/blob/master/task/task002/task002_26/js/control.js)，在我的github仓库查看源码。

除此之外还有一个闭包取for循环中正确的i值的办法，除了我经常用的匿名函数与直接给对象添加属性的方法外，我还发现了许多种方法，感兴趣的同学[点这里](http://www.cnblogs.com/syf/archive/2012/10/04/2711828.html)，我就不搬运过来了。

折腾了两天，任务一终于搞完啦，看着一个宇宙诞生在自己手里还是挺爽的。

#### task002_26 行星与飞船（二）

任务描述

基于任务二十六，我们继续改善我们的任务

第一代宇宙飞船系统真是糟糕的实现，所以我们需要进行改进飞船自身，我们在几个部件进行了更多的组合可能性，在创建新飞船时可以自行选择，[如图](http://7xrp04.com1.z0.glb.clouddn.com/task_2_27_1.jpg)

我们新增了几种动力系统，能够让飞船飞得更快，相应的能源消耗也会不同

我们新增了集中能源系统，能够让飞船能量补充能源速度越快

接下来改进的是指令的传播问题

我们发明了新一代的传播介质BUS，它的单次传播失败率降低到10%，传播速度提升到300ms，而且他增加了多次重试的功能，可以保证信息一定能够传递出去，请你实现这个可以通过多次重试保证在10%丢包率情况下顺利将信息传递出去的BUS传播介质

但BUS有个弱点，就是无法直接传递JSON格式，它只能传递二进制码，但指挥官并不能够直接下达二进制编码指令，所以我们需要在行星上的发射器部分增加一个模块Adapter，把原来的指令格式翻译成二进制码。同时还需要在飞船的接收器部分增加一个Adapter，用来把二进制码翻译成原来能够理解的指令格式

二进制码格式自定，可以参考的例子：前四位标示飞船编号，后四位标示具体指令（0001：开始飞行，0010：停止飞行，1100：自我销毁）

我的代码实现

不得不说句，这设定太带感了，新的传播介质，二进制，宇宙广播等等真是每个都让人嗨啊，不过我吸取了上个任务的经验教训，冷静冷静。

先看看我[更新后的宇宙](http://xxthink.com/baidu-ife/task/task002/task002_27/index.html)，整体逻辑界面还是继承自任务26，添加了新发明的传播物质BUS，行星上添加了发射器，飞船绑定了新的接受模块，指挥官的命令可以更稳定快速的被飞船接收到了。

在添加了新的功能模块后，我又回头看了看之前的代码，发现存在一个很严重的逻辑问题，那就是将指挥官的创建飞船命令与其他指挥飞船的命令一并广播出去，之后会出现一个很怪异的情况，飞船接受了来自指挥官的命令，然后创建了自己？！？那之前接受命令的又是谁呢？

不过幸好之前代码的耦合度不高，很快就解决了这个问题，至此，我的小宇宙更加酷炫了。

有时候会觉得能每天敲敲代码真是太美好了，不多说了，前端小萌新在路上！
